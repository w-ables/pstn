<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PSTN-404909 Sampler</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    /* MODIFIED BODY STYLE FOR SEAMLESS IFRAME INTEGRATION */
    body {
      font-family: 'Arial', sans-serif;
      background-color: transparent; /* Makes iframe background transparent */
      margin: 0;
      padding: 0; /* No padding on the body of the iframe content */
      display: flex; /* Still useful to center the .sampler div */
      justify-content: center;
      align-items: center;
      /* min-height: 100vh; /* This line is commented out or removed to prevent iframe scroll issues with fixed height */
      color: white; /* Default for any stray text, though sampler has its own colors */
    }
    
    /* YOUR EXISTING SAMPLER AND OTHER STYLES START HERE - UNCHANGED */
    .sampler {
      background-color: #35C6F2; 
      border-radius: 10px; 
      padding: 20px; 
      width: 100%;
      max-width: 550px; 
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
      border: 2px solid #1E88A8; 
      position: relative;
      display: flex; 
      flex-direction: column; 
    }

    .main-title {
        font-family: 'Exo 2', sans-serif; 
        font-size: 44px; 
        font-weight: 800; 
        color: #FFFFFF; 
        text-shadow: 1px 1px 3px rgba(0,0,0,0.4); 
        margin-bottom: 20px; 
        text-align: center; 
        width: 100%; 
        letter-spacing: 1.5px; 
        text-transform: uppercase; 
    }

    .knob-panel {
        background-color: #1C1C1C; 
        padding: 15px 10px 10px 10px;
        border-radius: 6px;
        margin-bottom: 15px;
        box-shadow: inset 0 3px 5px rgba(0,0,0,0.5);
    }
    
    .display {
      background-color: #0A0A0A; 
      color: #FFA500; /* Default color for text within .display */
      font-family: 'VT323', monospace; 
      height: 100px; 
      margin-bottom: 20px; 
      border-radius: 5px; 
      padding: 10px; /* Added padding for inner text */
      display: flex; 
      justify-content: center;
      align-items: center;
      box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.9);
      overflow: hidden; 
      position: relative; 
      border: 2px solid #222;
      text-align: center; 
      box-sizing: border-box; /* Include padding in height/width */
    }
    
    .display-grain-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; 
        background: 
            linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%), 
            linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.03));
        background-size: 100% 2px, 3px 100%;
        animation: grain-flicker 0.15s infinite;
        opacity: 0.2; 
        z-index: 1; 
    }

    @keyframes grain-flicker {
      0% { opacity: 0.15; transform: translate(0,0); }
      25% { opacity: 0.2; transform: translate(1px, -1px); }
      50% { opacity: 0.1; transform: translate(-1px, 1px); }
      75% { opacity: 0.25; transform: translate(1px, 1px); }
      100% { opacity: 0.15; transform: translate(0,0); }
    }

    .display-default-text {
        font-family: 'VT323', monospace;
        font-size: 24px; /* Adjusted size */
        color: #FFB84D; 
        line-height: 1.2;
        z-index: 2; 
        text-transform: lowercase;
        display: none; /* Controlled by JS */
        width: 100%; 
        padding: 5px; /* Ensure text doesn't touch edges */
        box-sizing: border-box;
    }
    
    .display-default-text.visible {
        display: block;
    }

    .display-status-overlay { 
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column; 
        justify-content: center;
        align-items: center;
        color: #FF8C00; 
        font-size: 28px; 
        font-weight: bold;
        text-shadow: 0 0 5px rgba(255, 140, 0, 0.7);
        z-index: 3; 
        background-color: rgba(10, 10, 10, 0.9);
        opacity: 0; 
        transition: opacity 0.2s ease-in-out;
        padding: 5px;
        box-sizing: border-box;
        text-align: center;
        pointer-events: none; 
    }

    .display-status-overlay.visible {
        opacity: 1;
        pointer-events: auto; 
    }
    .display-status-overlay .bpm-value {
        font-size: 48px; 
        line-height: 1;
    }
    .display-status-overlay .bpm-label {
        font-size: 16px;
        margin-top: -5px; 
    }

    .controls {
      display: flex;
      justify-content: space-around; 
      margin-bottom: 10px; 
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .knob {
      width: 42px; 
      height: 42px;
      background-color: #5DADE2; 
      border-radius: 50%;
      margin-bottom: 5px; 
      position: relative;
      border: 2px solid #34708E; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.35), inset 0 1px 2px rgba(255,255,255,0.25);
      cursor: grab;
    }

    .knob:active {
        cursor: grabbing;
    }
    
    .knob::after { 
      content: '';
      position: absolute;
      bottom: 50%; 
      left: 50%;   
      width: 3px;  
      height: 10px; 
      background-color: #FFFFFF; 
      border-radius: 1px; 
      transform-origin: center bottom; 
      transform: translateX(-50%) rotate(var(--knob-rotation-dynamic, -135deg)); 
      pointer-events: none; 
    }
    
    .knob-label {
      font-size: 9px;
      color: #D0D0D0; 
      text-align: center;
      font-weight: bold;
    }
    
    .buttons-grid { 
      display: grid;
      grid-template-columns: repeat(3, 1fr); 
      gap: 8px;
      margin-bottom: 15px;
    }
            
    .pads {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px; 
      background-color: #1E1E1E; 
      padding: 10px;
      border-radius: 6px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.6);
    }
    
    .pad {
      background-color: #686868; 
      color: #1C1C1C; 
      border-radius: 4px; 
      aspect-ratio: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 18px; 
      cursor: pointer;
      box-shadow: 0 3px 0 #484848; 
      position: relative; 
      user-select: none;
      transition: background-color 0.05s, box-shadow 0.05s, transform 0.05s;
    }
    
    .pad:hover {
        background-color: #7A7A7A;
    }

    .pad:active, .pad.active-playing { 
      background-color: #FF8000; 
      box-shadow: 0 1px 0 #D06800; 
      transform: translateY(2px);
      color: #FFFFFF;
    }
    
    .button {
      background-color: #383838; 
      color: #D8D8D8; 
      border-radius: 4px;
      display: flex;
      flex-direction: column; 
      justify-content: center;
      align-items: center;
      font-size: 9px; 
      font-weight: bold;
      line-height: 1.2;
      cursor: pointer;
      padding: 6px 4px; 
      text-align: center;
      box-shadow: 0 2px 0 #181818; 
      user-select: none;
      min-height: 35px; 
      transition: background-color 0.1s, box-shadow 0.1s, transform 0.1s;
    }
    
    .button:hover {
        background-color: #4A4A4A;
    }

    .button:active, .button.active {
      background-color: #FF7700; 
      color: white;
      box-shadow: 0 0 0 #101010;
      transform: translateY(2px);
    }
            
    @media (max-width: 600px) {
      .sampler { padding: 15px; max-width: 95%; }
      .main-title { font-size: 30px; margin-bottom: 15px;} 
      .knob { width: 38px; height: 38px; }
      .knob::after { 
        height: 8px; 
        width: 2.5px; 
      }
      .pad { font-size: 15px; }
      .button { font-size: 8px; padding: 5px 3px; min-height: 30px;}
      .display-default-text { font-size: 18px; }
      .display-status-overlay { font-size: 22px; }
      .display-status-overlay .bpm-value { font-size: 38px; }
      .display-status-overlay .bpm-label { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="sampler">
    <div class="main-title">PSTN-404909</div> <div class="knob-panel">
        <div class="controls">
          <div class="control-group">
            <div class="knob" id="volumeKnob" data-value="80"></div>
            <div class="knob-label">VOLUME</div>
          </div>
          <div class="control-group">
            <div class="knob" id="echoFeedbackKnob" data-value="0"></div> 
            <div class="knob-label">ECHO FEEDBACK</div>    
          </div>
          <div class="control-group">
            <div class="knob" id="reverbDecayKnob" data-value="30"></div>
            <div class="knob-label">REVERB DECAY</div>
          </div>
          <div class="control-group">
            <div class="knob" id="fxVolumeKnob" data-value="0"></div>
            <div class="knob-label">FX VOLUME</div>
          </div>
        </div>
    </div>
    
    <div class="display">
        <div id="defaultDisplayText" class="display-default-text">public spreads the news</div>
        <div id="statusDisplayText" class="display-status-overlay">
            </div>
        <div class="display-grain-overlay"></div>
    </div>
    
    <div class="buttons-grid">
      <div class="button" id="patternSelectButton">PATTERN<br>SELECT</div>
      <div class="button" id="recButton">REC</div>
      <div class="button" id="markButton">MARK</div> 
      <div class="button" id="deleteButton">DELETE</div> 
      <div class="button" id="loopButton">LOOP</div>
      <div class="button" id="startButton">START<br>STOP</div>
    </div>
    
    <div class="pads" id="pads">
      <div class="pad" data-pad="1">1</div> <div class="pad" data-pad="2">2</div>
      <div class="pad" data-pad="3">3</div> <div class="pad" data-pad="4">4</div>
      <div class="pad" data-pad="5">5</div> <div class="pad" data-pad="6">6</div>
      <div class="pad" data-pad="7">7</div> <div class="pad" data-pad="8">8</div>
      <div class="pad" data-pad="9">9</div> <div class="pad" data-pad="10">10</div>
      <div class="pad" data-pad="11">11</div><div class="pad" data-pad="12">12</div>
    </div>
        
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- Global State & Elements ---
      const defaultDisplayTextEl = document.getElementById('defaultDisplayText');
      const statusDisplayTextEl = document.getElementById('statusDisplayText');
      const padsContainer = document.getElementById('pads');
      
      // --- Tone.js Setup ---
      let mainVolume, feedbackDelay, reverb, fxCrossFade; 
      let toneJsInitialized = false;
      let playbackStartTime = 0; 
      const BPM = 110; 
      let displayStateTimeout = null; 

      // --- Sampler State ---
      const banks = { 
        defaultBank: { 
          1: ['kick.mp3', 'kick2.mp3'], 2: ['snare.mp3', 'clap.mp3'],
          3: ['hihat.mp3', 'openhat.mp3'], 4: ['perc.mp3', 'cowbell.mp3'],
          5: ['bass.mp3', 'sub.mp3'], 6: ['synth.mp3', 'pad.mp3'],
          7: ['vocal.mp3', 'vox.mp3'], 8: ['fx.mp3', 'sweep.mp3'],
          9: ['click.mp3', 'snap.mp3'], 10: ['tom.mp3', 'rimshot.mp3'],
          11: ['noise.mp3', 'crash.mp3'], 12: ['stab.mp3', 'chord.mp3']
        }
      };
      const loadedSounds = { defaultBank: {} }; 
      const currentBank = 'defaultBank'; 
      const padIndices = {}; 
      for (let i = 1; i <= 12; i++) padIndices[i] = 0;
      
      let isRecording = false;
      let recordedSequence = []; 
      let recordStartTime = 0;
      let isPlaying = false;
      let isLooping = false;
      const playbackTimeouts = [];
      let sequenceEndTimeout = null;

      let loopMarkerTimes = { start: null, end: null };

      // --- Display Update Function ---
      function updateMainDisplay(mode = 'idle', textContent = '') {
          clearTimeout(displayStateTimeout); 

          if (defaultDisplayTextEl) defaultDisplayTextEl.classList.remove('visible');
          if (statusDisplayTextEl) {
            statusDisplayTextEl.classList.remove('visible');
            statusDisplayTextEl.innerHTML = ''; 
          }

          switch (mode) {
              case 'idle':
                  if (defaultDisplayTextEl) defaultDisplayTextEl.classList.add('visible');
                  break;
              case 'recording':
                  if (statusDisplayTextEl) {
                    statusDisplayTextEl.innerHTML = 'RECORDING...';
                    statusDisplayTextEl.classList.add('visible');
                  }
                  break;
              case 'playing':
                  if (statusDisplayTextEl) {
                    statusDisplayTextEl.innerHTML = 'PLAYING...';
                    statusDisplayTextEl.classList.add('visible');
                  }
                  break;
              case 'tempo':
                  if (statusDisplayTextEl) {
                    statusDisplayTextEl.innerHTML = `<div class="bpm-value">${BPM}</div><div class="bpm-label">BPM</div>`;
                    statusDisplayTextEl.classList.add('visible');
                  }
                  displayStateTimeout = setTimeout(() => {
                      updateMainDisplay('idle');
                  }, 2500); 
                  break;
              case 'customText': 
                  if (statusDisplayTextEl) {
                    statusDisplayTextEl.innerHTML = textContent;
                    statusDisplayTextEl.classList.add('visible');
                  }
                  break;
          }
      }


      async function initAudio() {
        if (toneJsInitialized) return;
        try {
          await Tone.start(); 
          mainVolume = new Tone.Gain(0.8); 
          feedbackDelay = new Tone.FeedbackDelay({ delayTime: "8n.", feedback: 0.0, maxDelay: 1.0 });
